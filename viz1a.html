<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <link rel="icon" href="data:;base64,=">
        <title>Viz 1a</title>
        <script type="text/javascript" src="https://d3js.org/d3.v6.min.js"></script>
        <style type="text/css">
            body {
                font-family: sans-serif;
            }
            .spinner {
                border: 16px solid #f3f3f3; /* Light grey */
                border-top: 16px solid #3498db; /* Blue */
                border-radius: 50%;
                width: 120px;
                height: 120px;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .hover-bar {
                stroke-width: 1px;
                stroke: white;
                stroke-opacity: 0.5;
                -webkit-filter: drop-shadow( 2px 2px 2px rgba(0, 0, 0, .6));
                filter: drop-shadow( 2px 2px 2px rgba(0, 0, 0, .6));
            }

            .line {
                fill: none;
                stroke: steelblue;
                stroke-width: 2px;
            }

            .grid line {
                stroke: lightgrey;
                stroke-opacity: 0.7;
                shape-rendering: crispEdges;
            }

            .grid path {
                stroke-width: 0;
            }

            .tooltip {
                position: absolute;
                display: none;
                min-width: 80px;
                height: auto;
                background: none repeat scroll 0 0 #ffffff;
                border: 1px solid #6F257F;
                padding: 14px;
                text-align: center;
                border-radius: 10px;
            }
        </style>
    </head>
    <body>
        <div class="spinner"></div>

        <!-- to be populated using unique countries in dataset -->
        <select name="viz1-countries" id="viz1-countries" multiple></select>
        <br><br>
        <label for="viz1-attributes">Attribute: </label><select name="viz1-attributes" id="viz1-attributes"></select>

        <div class="viz1a"></div>

        <script type="text/javascript">
            // NOTE: always used classed("myclass", true) and not classed("myclass"), because the latter
            // will overwrite any classes that already exist there, which may not be what you want.
            const FONT_SIZES = {
                tick: 12,
                axisTitle: 14,
                title: 16
            }

            // color scale is here: https://github.com/d3/d3-scale-chromatic#schemeTableau10
            const continentColors = d3.scaleOrdinal(d3.schemeTableau10)
                                        .domain(["Africa", "Asia", "Europe", "North America", "Oceania", "South America"]);

            var viz1a = {};  // empty object which will contain all stuff necessary for drawing/redrawing viz1a

            var parseDate = d3.timeParse("%Y-%m-%d");  // for converting strings to dates ("2020-03-31", for example)
            var formatDate = d3.timeFormat("%b %e");  // for converting dates to strings

            var covidData;
            var dataDict;
            var viz1aSelectedCountries = [];
            var attribute;

            // TODO: delete this when ready for attribute dropdown and date slider
            //var attribute = "new_cases";  // for testing numeric attributes
            //var attribute = "c2_workplace_closing";  // for testing categorical attributes
            
            var the_date = parseDate("2020-07-01");

            function dictRowParser(d) {
                return {
                    variable_name :  d.variable_name,  // name of attribute in CSV
                    data_type :      d.data_type,  // string, date, numeric, or ordinal
                    display_name :   d.display_name,  // pretty name of variable, for dropdowns, titles, etc.
                    sort_order :     parseInt(d.sort_order),  // when showing in dropdown menus, sort in this order
                    category :       d.category,   // when grouping variables (e.g., in a summary table, these are the groupings)
                    numeric_column : d.numeric_column  // for ordinal columns, e.g., c1_school_closing, there is a corresponding "numeric" column
                };
            }

            function dataRowParser(d) {
                return {
                    countryname :                                  d.countryname,
                    date :                                         parseDate(d.date),
                    continent :                                    d.continent,
                    new_cases :                                    parseFloat(d.new_cases),
                    new_cases_per_million :                        parseFloat(d.new_cases_per_million),
                    total_cases :                                  parseFloat(d.total_cases),
                    total_cases_per_million :                      parseFloat(d.total_cases_per_million),
                    new_deaths :                                   parseFloat(d.new_deaths),
                    new_deaths_per_million :                       parseFloat(d.new_deaths_per_million),
                    total_deaths :                                 parseFloat(d.total_deaths),
                    total_deaths_per_million :                     parseFloat(d.total_deaths_per_million),
                    new_tests :                                    parseFloat(d.new_tests),
                    new_tests_per_thousand :                       parseFloat(d.new_tests_per_thousand),
                    total_tests :                                  parseFloat(d.total_tests),
                    total_tests_per_thousand :                     parseFloat(d.total_tests_per_thousand),
                    positive_rate :                                parseFloat(d.positive_rate),
                    reproduction_rate :                            parseFloat(d.reproduction_rate),
                    new_vaccinations :                             parseFloat(d.new_vaccinations),
                    new_vaccinations_per_hundred :                 parseFloat(d.new_vaccinations_per_hundred),
                    people_vaccinated :                            parseFloat(d.people_vaccinated),
                    people_vaccinated_per_hundred :                parseFloat(d.people_vaccinated_per_hundred),
                    people_fully_vaccinated :                      parseFloat(d.people_fully_vaccinated),
                    people_fully_vaccinated_per_hundred :          parseFloat(d.people_fully_vaccinated_per_hundred),
                    icu_patients :                                 parseFloat(d.icu_patients),
                    icu_patients_per_million :                     parseFloat(d.icu_patients_per_million),
                    hosp_patients :                                parseFloat(d.hosp_patients),
                    hosp_patients_per_million :                    parseFloat(d.hosp_patients_per_million),
                    weekly_icu_admissions :                        parseFloat(d.weekly_icu_admissions),
                    weekly_icu_admissions_per_million :            parseFloat(d.weekly_icu_admissions_per_million),
                    weekly_hosp_admissions :                       parseFloat(d.weekly_hosp_admissions),
                    weekly_hosp_admissions_per_million :           parseFloat(d.weekly_hosp_admissions_per_million),
                    stringency_index :                             parseFloat(d.stringency_index),
                    government_response_index :                    parseFloat(d.government_response_index),
                    containment_health_index :                     parseFloat(d.containment_health_index),
                    economic_support_index :                       parseFloat(d.economic_support_index),
                    c1_school_closing :                            d.c1_school_closing,
                    c1_school_closing_numeric :                    parseFloat(d.c1_school_closing_numeric),
                    c2_workplace_closing :                         d.c2_workplace_closing,
                    c2_workplace_closing_numeric :                 parseFloat(d.c2_workplace_closing_numeric),
                    c3_cancel_public_events :                      d.c3_cancel_public_events,
                    c3_cancel_public_events_numeric :              parseFloat(d.c3_cancel_public_events_numeric),
                    c4_restrictions_on_gatherings :                d.c4_restrictions_on_gatherings,
                    c4_restrictions_on_gatherings_numeric :        parseFloat(d.c4_restrictions_on_gatherings_numeric),
                    c5_close_public_transport :                    d.c5_close_public_transport,
                    c5_close_public_transport_numeric :            parseFloat(d.c5_close_public_transport_numeric),
                    c6_stay_at_home_requirements :                 d.c6_stay_at_home_requirements,
                    c6_stay_at_home_requirements_numeric :         parseFloat(d.c6_stay_at_home_requirements_numeric),
                    c7_restrictions_on_internal_movement :         d.c7_restrictions_on_internal_movement,
                    c7_restrictions_on_internal_movement_numeric : parseFloat(d.c7_restrictions_on_internal_movement_numeric),
                    c8_international_travel_controls :             d.c8_international_travel_controls,
                    c8_international_travel_controls_numeric :     parseFloat(d.c8_international_travel_controls_numeric),
                    e1_income_support :                            d.e1_income_support,
                    e1_income_support_numeric :                    parseFloat(d.e1_income_support_numeric),
                    e2_debt_contract_relief :                      d.e2_debt_contract_relief,
                    e2_debt_contract_relief_numeric :              parseFloat(d.e2_debt_contract_relief_numeric),
                    e3_fiscal_measures :                           parseFloat(d.e3_fiscal_measures),
                    e4_international_support :                     parseFloat(d.e4_international_support),
                    h1_public_information_campaigns :              d.h1_public_information_campaigns,
                    h1_public_information_campaigns_numeric :      parseFloat(d.h1_public_information_campaigns_numeric),
                    h2_testing_policy :                            d.h2_testing_policy,
                    h2_testing_policy_numeric :                    parseFloat(d.h2_testing_policy_numeric),
                    h3_contact_tracing :                           d.h3_contact_tracing,
                    h3_contact_tracing_numeric :                   parseFloat(d.h3_contact_tracing_numeric),
                    h6_facial_coverings :                          d.h6_facial_coverings,
                    h6_facial_coverings_numeric :                  parseFloat(d.h6_facial_coverings_numeric),
                    h7_vaccination_policy :                        d.h7_vaccination_policy,
                    h7_vaccination_policy_numeric :                parseFloat(d.h7_vaccination_policy_numeric),
                    h4_emergency_investment_in_healthcare :        parseFloat(d.h4_emergency_investment_in_healthcare),
                    h5_investment_in_vaccines :                    parseFloat(d.h5_investment_in_vaccines),
                    population :                                   parseFloat(d.population),
                    population_density :                           parseFloat(d.population_density),
                    median_age :                                   parseFloat(d.median_age),
                    aged_65_older :                                parseFloat(d.aged_65_older),
                    aged_70_older :                                parseFloat(d.aged_70_older),
                    gdp_per_capita :                               parseFloat(d.gdp_per_capita),
                    extreme_poverty :                              parseFloat(d.extreme_poverty),
                    cardiovasc_death_rate :                        parseFloat(d.cardiovasc_death_rate),
                    diabetes_prevalence :                          parseFloat(d.diabetes_prevalence),
                    female_smokers :                               parseFloat(d.female_smokers),
                    male_smokers :                                 parseFloat(d.male_smokers),
                    life_expectancy :                              parseFloat(d.life_expectancy),
                    human_development_index :                      parseFloat(d.human_development_index)
                };
            }


            function makeViz1a() {
                viz1a.margin = {top: 20, right: 20, bottom: 40, left: 175};

                viz1a.dims = {height: 400, width: d3.max([600,  // no smaller than 600px wide
                                                    d3.min([900, // no larger than 900px wide
                                                            Math.floor(window.innerWidth / 2)])])};
                viz1a.dims["innerHeight"] = viz1a.dims.height - viz1a.margin.top - viz1a.margin.bottom
                viz1a.dims["innerWidth"] = viz1a.dims.width - viz1a.margin.left - viz1a.margin.right

                viz1a.svg = d3.select("div.viz1a")
                                .append("svg")
                                    .attr("width", viz1a.dims.width)
                                    .attr("height", viz1a.dims.height)
                                    .classed("viz1a", true)
                                .append("g")
                                    .attr("transform", "translate(" + viz1a.margin.left + "," + viz1a.margin.top + ")");

                viz1a.yScale = d3.scaleBand()
                                .rangeRound([0, viz1a.dims.innerHeight - 10])
                                .paddingInner(0.1);

                viz1a.xScale = d3.scaleLinear()
                                .rangeRound([0, viz1a.dims.innerWidth]); // rangeRound ensures all pixel values are non-fractional

                // make y-axis
                viz1a.svg.append("g")
                    .classed("viz1a y axis", true);

                viz1a.yAxis = d3.axisLeft(viz1a.yScale);
                
                // make x-axis
                viz1a.svg.append("g")
                    .classed("viz1a x axis", true)
                    .attr("transform", "translate(0," + viz1a.dims.innerHeight + ")");

                viz1a.xAxis = d3.axisBottom(viz1a.xScale);

                // x-axis title
                viz1a.svg.append("text")
                    .classed("viz1a x axis-title", true)
                    .attr("transform",
                            "translate(" + Math.floor(viz1a.dims.innerWidth/2 - viz1a.margin.left/2) + " ," + 
                                        (viz1a.dims.innerHeight + viz1a.margin.top + 15) + ")")
                    .style("text-anchor", "middle")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", FONT_SIZES.axisTitle)
                    .text("");
                
                // x-axis gridlines
                // see: https://bl.ocks.org/d3noob/c506ac45617cf9ed39337f99f8511218
                viz1a.svg.append("g")
                    .classed("viz1a x grid", true)
                    .attr("transform", "translate(0," + viz1a.dims.innerHeight + ")");
                
                viz1a.xAxisTicks = d3.axisBottom(viz1a.xScale)
                                    .tickSize(-viz1a.dims.innerHeight)
                                    .tickFormat("");

                viz1a.tooltip = d3.select("body")
                                .append("div")
                                .classed("viz1a tooltip", true);

            }
            

            function redrawViz1a() {
                let viz1aData = covidData.filter(d => viz1aSelectedCountries.includes(d.countryname) && 
                                                     d.date.getTime() == the_date.getTime());

                let var_metadata = dataDict.filter(d => d.variable_name == attribute)[0];

                // if ordinal, use numeric_column attribute (e.g., c1_school_closing_numeric), otherwise use attribute as selected
                let attributeName = var_metadata.display_name;
                let attributeData = var_metadata.data_type == "ordinal" ? var_metadata.numeric_column : attribute;

                // in case we removed all the data, don't show any axes or gridlines
                let axis_visibility = viz1aData.length == 0 ? "display:none" : "";
                d3.selectAll(".x").attr("style", axis_visibility);
                d3.selectAll(".y").attr("style", axis_visibility);
                d3.selectAll(".grid").attr("style", axis_visibility);

                /******
                 * update y-axis
                ******/
                //** Doing it this way so that we can maintain the order in which the user selected countries
                // Uncomment the below if you want to do it in the order of the dataset, not the user's selection:
                //      viz1a.yScale.domain(viz1aData.map(d => d.countryname));
                viz1a.yScale.domain(viz1aSelectedCountries);

                d3.select(".viz1a.y.axis")
                    .transition()
                    .duration(500)
                    .call(viz1a.yAxis);

                // remove y-axis ticks and vertical black line
                d3.selectAll(".viz1a.y.axis .tick line").remove();
                d3.selectAll(".viz1a.y.axis path").remove();

                /******
                 * update x-axis
                ******/
                // see if this variable is ordinal; if it does, use its "_numeric" column

                if((var_metadata.data_type == "ordinal")) {
                    // get largest value over entire dataset, not just selection
                    let maxValue = d3.max(covidData, d => d[attributeData]);

                    // set tick values to exactly these values
                    // e.g., if maxValue = 2.5, ticks will be: 0, 0.5, 1, 1.5, 2, 2.5
                    viz1a.xScale.domain([0, maxValue]);
                    viz1a.xAxis.tickValues(d3.range(0, maxValue + 0.5, 0.5));
                } else {
                    viz1a.xScale.domain([0, d3.max(viz1aData, d => d[attributeData])]);
                    
                    // if we switched from an ordinal variable, get rid of the manually specified ticks
                    viz1a.xAxis.tickValues(null);
                    viz1a.xAxisTicks.ticks(5);
                }


                d3.select(".viz1a.x.axis")
                    .transition()
                    .duration(300)
                    .call(viz1a.xAxis);
                
                // update x-axis title in case the attribute changed
                d3.select("text.viz1a.x.axis-title")
                    .text(attributeName);

                // add the X gridlines
                // see: https://bl.ocks.org/d3noob/c506ac45617cf9ed39337f99f8511218
                d3.select(".viz1a.grid")
                    .call(viz1a.xAxisTicks);

                // set all ticks' fonts. These aren't styles/CSS, these are attributes
                d3.selectAll(".viz1a.axis")
                    .attr("font-size", FONT_SIZES.tick)
                    .attr("font-family", "sans-serif");

                // Create the bars: there will be one with the actual data, and one that is invisible
                // which extends the length of the chart and activates the hover effect
                let bars = viz1a.svg.selectAll("rect")
                            .data(viz1aData, d => d.countryname);

                bars.exit()
                    .transition()
                    .duration(300)
                    .style("fill-opacity", 0)
                    .remove();

                bars.enter()
                    .append("rect")
                        .attr("fill", d => continentColors(d.continent))
                        .classed("viz1a bar", true)
                        .attr("id", function(d,i) {return "viz1a-bar" + i})
                        .merge(bars)
                            .on("mouseover", function() {
                                d3.select(this).classed("hover-bar", true);
                            }).on("mousemove", function(event, d) {
                                viz1a.tooltip
                                    .style("left", event.pageX - 50 + "px")
                                    .style("top", event.pageY - 70 + "px")
                                    .style("display", "inline-block")
                                    // note: display attributeName's value, not attributeData, because we want to see the categorical value, not numeric version
                                    .html((d.countryname) + "<br><b>" + attributeName + "</b>: " + d[attribute]);
                            }).on("mouseout", function() {
                                d3.select(this).classed("hover-bar", false);
                                viz1a.tooltip.style("display", "none");
                            })
                            .transition()
                            .duration(500)
                            .attr("y", d => viz1a.yScale(d.countryname))
                            .attr("height", viz1a.yScale.bandwidth())
                            .attr("width", d => viz1a.xScale(d[attributeData]));

                // Add a transparent bar on top that extends the width of the chart so we can activate
                //     the hover effect at any point along axis in the case of short bars.
                // Also include a tooltip! (reference: https://bl.ocks.org/alandunning/274bf248fd0f362d64674920e85c1eb7)
            }

            // load the data and kick things off
            Promise.all([
                d3.csv("../data/data_dictionary.csv", dictRowParser),
                d3.csv("../data/covid_data.csv", dataRowParser),
            ]).then(function(files) {
                dataDict = files[0];
                covidData = files[1];

                console.log("Imported all data!");

                /***************************
                * Countries select list. Add countries to select list and set up "change" listener to redraw
                **************************/
                selectCountry = d3.select("select#viz1-countries");

                // get unique countries, then append <option> to <select>
                Array.from(new Set(covidData.map(d => d.countryname)))
                    .sort()  // put country names in order in dropdown menu
                    .forEach(function(country) {
                        selectCountry.append('option')
                            .attr("value", country)
                            .text(country);
                    });

                // create listener
                selectCountry
                    .on("change", function() {
                        let countries = [];

                        selected = d3.select(this)
                            .selectAll("option:checked") 
                            .each(function() { countries.push(this.value) }); // for each select country, get its value (name)

                        // want to maintain ordering of original selection
                        viz1aSelectedCountries = viz1aSelectedCountries.filter(d => countries.includes(d));
                        added = countries.filter(d => !viz1aSelectedCountries.includes(d));
                        viz1aSelectedCountries = viz1aSelectedCountries.concat(added);

                        redrawViz1a();
                    });

                
                /***************************
                * Attributes dropdown. Add attributes with <optgroup> for each category, <option> for each attribute
                **************************/
                //add attributes to the attribute dropdown menu;
                selectAttr = d3.select("select#viz1-attributes");

                // first, put categories in as optgroups
                Array.from(new Set(dataDict.filter(d => d.sort_order != 0)
                                           .map(d => d.category)))
                    .forEach(function(category) {
                        selectAttr.append("optgroup")
                            .attr("label", category);
                    });
                
                // now put attributes into the optgroups
                dataDict.filter(d => d.sort_order != 0)
                        .map(d => ({category : d.category, 
                                    variable_name : d.variable_name,
                                    display_name : d.display_name}))
                        .forEach(function(attrRow, i) {
                            d3.select("optgroup[label='" + attrRow.category + "']")
                                .append("option")
                                .attr("value", attrRow.variable_name)
                                .text(attrRow.display_name);
                            
                            // initialize attribute to first row in data dictionary
                            if(i == 0) {attribute = attrRow.variable_name;}
                        });
                
                // create listener
                selectAttr
                    .on("change", function() {
                        attribute = d3.select(this)
                                        .select("option:checked") 
                                        .attr("value");  // want value (variable_name), not the text (display_name)
                        redrawViz1a();
                    });
                
                /***************************
                * Create the viz!
                **************************/
                makeViz1a();
                redrawViz1a();
                d3.selectAll(".spinner").remove();

            }).catch(function(err) {
                d3.selectAll(".spinner").remove();
                console.error('Error: ' + err);
            })
        </script>
    </body>
</html>
